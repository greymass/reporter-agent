---
import { getCollection } from 'astro:content';

// Get all reports and organize by month
const allReports = await getCollection('docs');

// Group reports by month (YYYY-MM)
const reportsByMonth = allReports.reduce((acc: Record<string, any[]>, report) => {
  const match = report.id.match(/^(\d{4}-\d{2})/);
  if (match) {
    const month = match[1];
    if (!acc[month]) acc[month] = [];
    acc[month].push(report);
  }
  return acc;
}, {});

// Sort months in descending order (newest first)
const sortedMonths = Object.keys(reportsByMonth).sort().reverse();

// Get current path to highlight active report
const currentPath = Astro.url.pathname;
---

<aside class="drawer-side z-10">
  <label for="my-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
  <div class="menu p-4 w-80 min-h-full bg-base-200 text-base-content">
    <div class="mb-4">
      <h2 class="text-2xl font-bold text-primary mb-2">Reports</h2>
      <p class="text-sm opacity-70">Monthly development activity</p>
    </div>
    
    <ul class="menu-compact">
      {sortedMonths.map((month) => {
        const reports = reportsByMonth[month];
        const [year, monthNum] = month.split('-');
        const monthName = new Date(parseInt(year), parseInt(monthNum) - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        
        return (
          <li class="mb-2">
            <details open={currentPath.includes(month)}>
              <summary class="font-semibold text-lg">
                {monthName}
              </summary>
              <ul>
                {reports.map((report) => {
                  const slug = report.id.replace(/\.md$/i, '').toLowerCase();
                  const filename = report.id.split('/').pop()?.replace(/\.md$/i, '') || '';
                  const href = `/reports/${slug}/`;
                  const isActive = currentPath.includes(slug);
                  
                  return (
                    <li>
                      <a 
                        href={href} 
                        class={isActive ? 'active' : ''}
                      >
                        {filename}
                      </a>
                    </li>
                  );
                })}
              </ul>
            </details>
          </li>
        );
      })}
    </ul>
  </div>
</aside>
